<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Your tailored sample</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="color-scheme" content="light dark">
  <style>
    :root { --bg:#0b0b0c; --fg:#f5f7fb; --muted:#a7adbb; --card:#14161a; --accent:#3b82f6; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    a{color:var(--accent)}
    .wrap{max-width:1000px;margin:0 auto;padding:28px 20px 60px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;gap:16px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,#4f46e5,#06b6d4)}
    .title{font-weight:700;letter-spacing:.2px}
    .hero{padding:18px;border:1px solid #22262d;background:var(--card);border-radius:14px}

    /* Video wrapper + defaults */
    .vwrap{display:flex;justify-content:center;align-items:center}
    .vwrap video{
      width:100%;
      height:auto;          /* keeps vertical videos tall */
      background:#0e1013;
      border-radius:10px;
      outline:none;
      object-fit:contain;   /* letterbox if needed */
    }
    /* Portrait-only cap so tall videos don’t look huge */
    .vwrap.portrait video{
      max-width:min(480px, 85vh);  /* tweak to taste */
    }

    .actions{margin-top:12px;display:flex;gap:10px}
    .btn{display:inline-block;padding:10px 14px;border-radius:10px;background:var(--accent);color:#fff;text-decoration:none;font-weight:600}
    .btn:hover{opacity:.9}
    .msg{padding:14px;border:1px dashed #333842;background:#111318;border-radius:12px;color:var(--muted);margin-top:14px}
    .error{border-color:#6b1f1f;background:#1a1111;color:#ffdbdb}
    .hide{display:none}
    footer{margin-top:26px;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">Matly Creative</div>
      </div>
    </header>

    <section class="hero">
      <div id="vwrap" class="vwrap">
        <video id="vid" controls playsinline preload="metadata"></video>
      </div>
      <div class="actions">
        <a id="dl" class="btn hide" href="#" download>Download</a>
      </div>
      <div id="status" class="msg hide"></div>
    </section>

    <footer>
      © <span id="year"></span> Matly Creative — high-converting real-estate video samples.
    </footer>
  </div>

  <script>
  (function(){
    const qs = new URLSearchParams(location.search);
    const id = qs.get('id');
    const status = document.getElementById('status');
    const video  = document.getElementById('vid');
    const dl     = document.getElementById('dl');
    const vwrap  = document.getElementById('vwrap');
    document.getElementById('year').textContent = new Date().getFullYear();

    function show(msg, isErr=false){
      status.textContent = msg || "";
      status.classList.toggle('hide', !msg);
      status.classList.toggle('error', !!isErr);
    }

    if (!id) { show('Missing link id.', true); return; }

    fetch(`/api/sample?id=${encodeURIComponent(id)}`, { cache: 'no-store' })
      .then(r => r.ok ? r.json() : Promise.reject(new Error('API error')))
      .then(({ streamUrl, foundKey, error }) => {
        if (!streamUrl) {
          show(
            error && /POINTER|OBJECT|EMPTY/.test(error)
              ? 'Your sample is not ready yet. Try again in a minute.'
              : 'Server error. Please refresh.',
            true
          );
          return;
        }

        // Set video source
        video.src = streamUrl;
        video.load();

        // Portrait detection once metadata is available
        video.addEventListener('loadedmetadata', () => {
          const w = video.videoWidth || 0;
          const h = video.videoHeight || 0;
          const isPortrait = w > 0 && h > 0 && h > w;
          vwrap.classList.toggle('portrait', !!isPortrait);
        }, { once: true });

        // Download button wiring
        if (foundKey) {
          dl.href = `/api/stream?key=${encodeURIComponent(foundKey)}&download=1`;
          dl.setAttribute('download', foundKey.split('/').pop() || 'video.mp4');
          dl.classList.remove('hide');
        } else {
          dl.classList.add('hide');
        }

        // Handle media load errors gracefully
        video.addEventListener('error', () => show('Hmm, failed to load video. Please refresh.', true), { once:true });

        show('');
      })
      .catch(() => show('Server error. Please refresh.', true));
  })();
  </script>
</body>
</html>
