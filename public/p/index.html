<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const id = qs.get('id');
  const status = document.getElementById('status');
  const video  = document.getElementById('vid');
  const chip   = document.getElementById('companyChip');
  const dl     = document.getElementById('dl');

  function show(msg, isErr=false){
    if (!status) return;
    status.textContent = msg || "";
    status.classList.toggle('hide', !msg);
    status.classList.toggle('error', !!isErr);
  }

  if (!id) { show('Missing link id.', true); return; }

  fetch(`/api/sample?id=${encodeURIComponent(id)}`, { cache: 'no-store' })
    .then(r => r.ok ? r.json() : Promise.reject(new Error('API error')))
    // ✅ include foundKey here
    .then(({ streamUrl, company, foundKey, error }) => {
      if (company) { chip.textContent = company; chip.classList.remove('hide'); }

      if (!streamUrl) {
        show(
          error && /POINTER|OBJECT|EMPTY/.test(error)
            ? 'Your sample is not ready yet. Try again in a minute.'
            : 'Server error. Please refresh.',
          true
        );
        return;
      }

      // Set video source and load
      video.src = streamUrl;
      video.load();

      // ✅ Wire the Download button when we know the actual key
      if (dl) {
        if (foundKey) {
          dl.href = `/api/stream?key=${encodeURIComponent(foundKey)}&download=1`;
          dl.setAttribute('download', foundKey.split('/').pop() || 'video.mp4');
          dl.classList.remove('hide');
        } else {
          dl.classList.add('hide');
        }
      }

      show('');
    })
    .catch(() => show('Server error. Please refresh.', true));
})();
</script>
