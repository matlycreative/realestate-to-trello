name: Prep personalized links (Trello, no CSV)

on:
  push:
    paths:
      - "uploads/**"          # auto-run when you add/rename in uploads/
  workflow_dispatch:          # also let you click “Run workflow”

jobs:
  prep-and-send:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo (with LFS just in case)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install rclone + jq
        run: |
          sudo apt-get update
          sudo apt-get install -y rclone jq

      - name: Configure rclone for R2
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf <<EOF
          [r2]
          type = s3
          provider = Cloudflare
          access_key_id = ${{ secrets.R2_ACCESS_KEY_ID }}
          secret_access_key = ${{ secrets.R2_SECRET_ACCESS_KEY }}
          endpoint = ${{ secrets.R2_ENDPOINT }}
          EOF

      - name: Upload videos in uploads/, write pointers, export email/link vars
        env:
          PUBLIC_BASE: ${{ secrets.PUBLIC_BASE }}
          R2_BUCKET:   ${{ secrets.R2_BUCKET }}
        run: |
          set -e
          shopt -s nullglob

          make_safe () { echo "$1" | tr '[:upper:]' '[:lower:]' | sed 's/[@.]/_/g'; }

          files=(uploads/*)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No files in uploads/ — nothing to do."
            exit 0
          fi

          for f in "${files[@]}"; do
            [ -f "$f" ] || continue
            base=$(basename "$f")                         # e.g. jane@acme.com__tour.mp4
            email="${base%%__*}"                          # e.g. jane@acme.com
            rest="${base#*__}"                            # e.g. tour.mp4
            safe=$(make_safe "$email")                    # e.g. jane_acme_com
            SAFE_UPPER=$(echo "$safe" | tr '[:lower:]' '[:upper:]')

            # Skip junk files (like .DS_Store)
            case "$base" in
              .DS_Store|*.tmp|*.part) echo "Skipping $base"; continue;;
            esac

            vid_key="videos/${safe}__${rest}"             # videos/jane_acme_com__tour.mp4
            echo "Uploading $f -> r2:${R2_BUCKET}/${vid_key}"
            rclone copy "$f" r2:${R2_BUCKET}/${vid_key} -vv

            # Optional: pull company from Trello (desc line 'company: ...')
            company=""
            if [ -n "${{ secrets.TRELLO_KEY }}" ] && [ -n "${{ secrets.TRELLO_TOKEN }}" ]; then
              if [ -n "${{ secrets.TRELLO_LIST_ID }}" ]; then
                curl -s "https://api.trello.com/1/lists/${{ secrets.TRELLO_LIST_ID }}/cards?fields=name,desc&key=${{ secrets.TRELLO_KEY }}&token=${{ secrets.TRELLO_TOKEN }}" > cards.json
              elif [ -n "${{ secrets.TRELLO_BOARD_ID }}" ]; then
                curl -s "https://api.trello.com/1/boards/${{ secrets.TRELLO_BOARD_ID }}/cards?fields=name,desc&key=${{ secrets.TRELLO_KEY }}&token=${{ secrets.TRELLO_TOKEN }}" > cards.json
              fi
              if [ -s cards.json ]; then
                card=$(jq -r --arg em "$email" '.[] | select(.desc|test($em;"i"))' cards.json | head -n 1)
                if [ -n "$card" ]; then
                  desc=$(echo "$card" | jq -r '.desc')
                  company=$(printf "%s\n" "$desc" | grep -i '^company:' | head -n 1 | sed 's/^company:[[:space:]]*//I')
                fi
              fi
            fi
            if [ -z "$company" ]; then
              domain=${email#*@}
              company=$(echo "${domain%%.*}" | sed -E 's/[-_]/ /g; s/.*/\u&/')
            fi

            # Pointer JSON (NOTE: no extra 'samples/' prefix here)
            printf '{"key":"%s","company":"%s"}\n' "$vid_key" "$company" > pointer.json
            ptr_key="pointers/${safe}.json"
            echo "Writing pointer r2:${R2_BUCKET}/${ptr_key}"
            rclone copyto "$f" "r2:${R2_BUCKET}/${vid_key}" -vv
            
            # Export env vars for your existing email step
            echo "RECIPIENT_EMAIL_${SAFE_UPPER}=${email}" >> $GITHUB_ENV
            echo "COMPANY_${SAFE_UPPER}=${company}"       >> $GITHUB_ENV
            echo "LANDING_URL_${SAFE_UPPER}=${PUBLIC_BASE}/p/?id=${safe}" >> $GITHUB_ENV

            echo "::notice title=Prepared::Email to ${email} — link ${PUBLIC_BASE}/p/?id=${safe}"
          done

      - name: List R2 paths (debug)
        run: |
          echo "videos/"
          rclone ls r2:${{ secrets.R2_BUCKET }}/videos || true
          echo "pointers/"
          rclone ls r2:${{ secrets.R2_BUCKET }}/pointers || true
