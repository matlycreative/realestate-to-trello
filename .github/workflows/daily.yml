name: Daily Real Estate Leads

on:
  workflow_dispatch:
    inputs:
      daily_limit:
        description: "Override leads count (optional)"
        required: false
      push_interval_s:
        description: "Override delay seconds (optional)"
        required: false
  schedule:
    - cron: "0 7 * * *"   # daily at 07:00 UTC

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Preflight secrets
        env:
          TRELLO_KEY: ${{ secrets.TRELLO_KEY }}
          TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}
          TRELLO_LIST_ID: ${{ secrets.TRELLO_LIST_ID }}
        run: |
          python - <<'PY'
          import os, sys
          req = ["TRELLO_KEY","TRELLO_TOKEN","TRELLO_LIST_ID"]
          miss = [k for k in req if not os.getenv(k)]
          if miss:
              print("❌ Missing secrets:", ", ".join(miss)); sys.exit(1)
          print("✅ Secrets present.")
          PY

      - name: Trello list check
        env:
          TRELLO_KEY: ${{ secrets.TRELLO_KEY }}
          TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}
          TRELLO_LIST_ID: ${{ secrets.TRELLO_LIST_ID }}
        run: |
          python - <<'PY'
          import os, sys, requests
          lid=os.getenv("TRELLO_LIST_ID"); key=os.getenv("TRELLO_KEY"); tok=os.getenv("TRELLO_TOKEN")
          r=requests.get(f"https://api.trello.com/1/lists/{lid}", params={"key":key,"token":tok}, timeout=30)
          print("Status:", r.status_code)
          if r.status_code!=200:
              print(r.text[:500]); sys.exit(1)
          print("✅ Trello list OK:", r.json().get("name"))
          PY

      - name: Run daily pipeline
        env:
          TRELLO_KEY: ${{ secrets.TRELLO_KEY }}
          TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}
          TRELLO_LIST_ID: ${{ secrets.TRELLO_LIST_ID }}
          TRELLO_TEMPLATE_CARD_ID: ${{ secrets.TRELLO_TEMPLATE_CARD_ID }}
          FOURSQUARE_API_KEY: ${{ secrets.FOURSQUARE_API_KEY }}
          USER_AGENT: "EditorLeads/1.0"
          DAILY_LIMIT: ${{ inputs.daily_limit || '10' }}
          PUSH_INTERVAL_S: ${{ inputs.push_interval_s || '60' }}
          REQUEST_DELAY_S: "1.0"
        run: python realestate_to_trello.py
