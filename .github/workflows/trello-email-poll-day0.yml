name: Trello Day 0 Email (poll)

on:
  # lets you run it manually from the Actions tab for testing
  workflow_dispatch:
  # polls every 5 minutes (you can change/remove this later)
  schedule:
    - cron: "*/5 * * * *"

permissions:
  contents: read
  actions: read

# avoid overlapping runs
concurrency:
  group: trello-day0-email
  cancel-in-progress: true

jobs:
  send:
    # uncomment and set if you used Environment-scoped secrets
    # environment: production
    runs-on: ubuntu-latest
    timeout-minutes: 15

    env:
      # Trello auth
      TRELLO_KEY:          ${{ secrets.TRELLO_KEY }}
      TRELLO_TOKEN:        ${{ secrets.TRELLO_TOKEN }}

      # The Trello LIST ID to watch for Day 0 emails
      # If you accidentally stored it as a Repository Variable instead of a Secret,
      # this fallback still picks it up:
      TRELLO_LIST_ID_DAY0: ${{ secrets.TRELLO_LIST_ID_DAY0 || vars.TRELLO_LIST_ID_DAY0 }}

      # SMTP auth (Option A)
      SMTP_USER:           ${{ secrets.SMTP_USER }}
      SMTP_PASS:           ${{ secrets.SMTP_PASS }}

      # From address; falls back to SMTP_USER if not provided
      EMAIL_FROM:          ${{ secrets.EMAIL_FROM || secrets.SMTP_USER }}

      # sender behavior
      DAILY_EMAIL_LIMIT:   10
      DEBUG:               "1"

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "requirements.txt"

      # Shows which critical envs are wired (SET/MISSING) without printing values
      - name: Preflight (show which envs are set)
        run: |
          python - <<'PY'
          import os, sys
          req = ["TRELLO_KEY","TRELLO_TOKEN","TRELLO_LIST_ID_DAY0","SMTP_USER","SMTP_PASS","EMAIL_FROM"]
          missing = []
          for k in req:
              ok = bool(os.getenv(k))
              print(f"{k}: {'SET' if ok else 'MISSING'}")
              if not ok: missing.append(k)
          if missing:
              print("\nMissing required env(s): " + ", ".join(missing))
              sys.exit(1)
          PY

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Run sender
        run: python trello_email_poll.py
