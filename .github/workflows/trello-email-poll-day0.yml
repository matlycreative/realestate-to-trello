name: Trello Day0 Email Sender

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *"   # poll every 5 minutes

concurrency:
  group: trello-day0-emailer
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  send:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      # Trello
      TRELLO_KEY: ${{ secrets.TRELLO_KEY }}
      TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}
      TRELLO_LIST_ID_DAY0: ${{ secrets.TRELLO_LIST_ID_DAY0 }}

      # SMTP
      SMTP_HOST: smtp.gmail.com
      SMTP_PORT: 587
      SMTP_USE_TLS: "1"
      SMTP_PASS: ${{ secrets.SMTP_PASS }}     # App password or SMTP password
      # Optional: set explicit SMTP_USER; if omitted, script uses FROM_EMAIL
      # SMTP_USER: ${{ secrets.SMTP_USER }}

      # From identity
      FROM_NAME: ${{ secrets.FROM_NAME }}
      FROM_EMAIL: ${{ secrets.FROM_EMAIL }}

      # Templates
      SUBJECT_A: ${{ secrets.SUBJECT_A }}
      BODY_A: ${{ secrets.BODY_A }}
      SUBJECT_B: ${{ secrets.SUBJECT_B }}
      BODY_B: ${{ secrets.BODY_B }}

      # Idempotency marker (per-list)
      SENT_MARKER_TEXT: "Sent: Day0"

      # Optional local cache (only for the current run)
      SENT_CACHE_FILE: ".data/sent_day0.json"

    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Ensure data dir
        run: mkdir -p .data

      - name: Preflight env check
        run: |
          python - <<'PY'
          import os, sys
          need = ["TRELLO_KEY","TRELLO_TOKEN","TRELLO_LIST_ID_DAY0","FROM_EMAIL","SMTP_PASS",
                  "SUBJECT_A","BODY_A","SUBJECT_B","BODY_B"]
          missing = [n for n in need if not os.getenv(n)]
          if missing:
              print("Missing required env:", ", ".join(missing)); sys.exit(1)
          PY

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install requests

      - name: Run sender
        run: python trello_email_poll.py
